{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Study Mode" %} - {{ exam.title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12 mx-auto max-w-4xl">
            <div class="card shadow-lg">
                <div class="card-header pb-0 text-left bg-gradient-primary text-white">
                    <h3 class="mb-0">{% trans "Study Mode" %} - {{ exam.title }}</h3>
                    <p class="mb-0">{% trans "2 bo'lim, har birida 22 ta savol. Vaqtsiz, lekin ketma-ket yakunlanadi." %}</p>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-center mb-4">
                        <button id="section-1-btn" class="btn btn-outline-primary mx-2" disabled>Bo'lim 1</button>
                        <button id="section-2-btn" class="btn btn-outline-primary mx-2" disabled>Bo'lim 2</button>
                    </div>

                    <div class="progress mb-4 h-6">
                        <div id="progress-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="44"></div>
                    </div>
                    <div class="d-flex flex-column sm:flex-row justify-content-between text-sm text-gray-600 mb-4 space-y-2 sm:space-y-0 sm:space-x-4">
                        <span id="question-counter">Savollar: 0/44</span>
                        <span id="correct-counter">To'g'ri: 0 (0%)</span>
                        <span id="incorrect-counter">Noto'g'ri: 0</span>
                    </div>

                    <div id="question-area" class="d-none">
                        <div id="passage-text-container" class="card card-body bg-gray-100 mb-4 d-none">
                            <h6 class="text-uppercase text-muted">{% trans "Matn (Passage)" %}</h6>
                            <p class="mb-0" id="passage-text"></p>
                        </div>
                        
                        <div id="question-text-container" class="card card-body shadow-sm mb-4">
                            <h5 class="mb-3" id="question-number"></h5>
                            <p class="mb-0 text-base md:text-lg" id="question-text"></p>
                            <div id="question-image-container" class="text-center mt-3 d-none">
                                <img id="question-image" class="img-fluid rounded max-w-full h-auto" alt="Question Image">
                            </div>
                        </div>

                        <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>

                        <div id="short-answer-container" class="mt-4 d-none">
                            <input type="text" id="short-answer-input" class="form-control w-full p-2 border rounded-lg" placeholder="{% trans 'Javobingizni kiriting' %}">
                        </div>

                        <div class="d-flex flex-column sm:flex-row justify-content-between mt-4 space-y-2 sm:space-y-0 sm:space-x-4">
                            <button id="hint-btn" class="btn btn-warning" type="button" disabled>{% trans "Maslahat" %}</button>
                            <button id="check-answer-btn" class="btn btn-success" type="button" disabled>{% trans "Javobni tekshirish" %}</button>
                            <button id="next-question-btn" class="btn btn-primary d-none" type="button">{% trans "Keyingi savol" %}</button>
                            <button id="mark-review-btn" class="btn btn-outline-info d-none" type="button">{% trans "Takrorlash uchun belgilash" %}</button>
                        </div>
                    </div>
                    
                    <div id="feedback-area" class="mt-4 d-none">
                        <div id="answer-feedback" class="alert d-none text-center" role="alert"></div>
                        <div class="card card-body mt-3 d-none" id="solution-container">
                            <h5 class="card-title">{% trans "Yechim" %}</h5>
                            <div id="solution-text"></div>
                        </div>
                    </div>

                    <div id="loading-area" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Yuklanmoqda...</span>
                        </div>
                        <p class="mt-2">{% trans "Savol yuklanmoqda..." %}</p>
                    </div>

                    <div id="finished-area" class="text-center d-none">
                        <h4 class="text-success">{% trans "Study Sessiya Yakunlandi!" %}</h4>
                        <p>{% trans "Barcha savollarni ko'rib chiqdingiz." %}</p>
                        <div class="mt-4">
                            <p id="final-stats" class="text-gray-700"></p>
                            <button id="review-incorrect-btn" class="btn btn-info mt-3 d-none">{% trans "Noto'g'ri javoblarni takrorlash" %}</button>
                            <a href="{% url 'home' %}" class="btn btn-primary mt-3">{% trans "Bosh sahifaga qaytish" %}</a>
                        </div>
                    </div>

                    <div id="error-area" class="alert alert-danger d-none text-center mt-4">
                        <p id="error-message">Xatolik yuz berdi. Iltimos, qayta urinib ko'ring.</p>
                        <button id="retry-btn" class="btn btn-outline-danger mt-2">Qayta urinish</button>
                    </div>

                    <div id="achievement-notification" class="fixed bottom-4 right-4 bg-green-600 text-white p-4 rounded-lg shadow-lg d-none">
                        <p id="achievement-text"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="hint-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
            <h5 class="text-lg font-semibold">{% trans "Maslahat" %}</h5>
            <button id="close-hint-btn" class="text-gray-600 hover:text-gray-800">&times;</button>
        </div>
        <p id="hint-text" class="text-gray-700"></p>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        svg: {
            fontCache: 'global'
        }
    };
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elementlarni chaqirish
        const questionArea = document.getElementById('question-area');
        const loadingArea = document.getElementById('loading-area');
        const finishedArea = document.getElementById('finished-area');
        const errorArea = document.getElementById('error-area');
        const errorMessageEl = document.getElementById('error-message');
        const retryBtn = document.getElementById('retry-btn');
        const questionTextEl = document.getElementById('question-text');
        const questionNumberEl = document.getElementById('question-number');
        const questionImageEl = document.getElementById('question-image');
        const questionImageContainer = document.getElementById('question-image-container');
        const optionsContainer = document.getElementById('options-container');
        const shortAnswerContainer = document.getElementById('short-answer-container');
        const shortAnswerInput = document.getElementById('short-answer-input');
        const hintBtn = document.getElementById('hint-btn');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const markReviewBtn = document.getElementById('mark-review-btn');
        const reviewIncorrectBtn = document.getElementById('review-incorrect-btn');
        const progressBar = document.getElementById('progress-bar');
        const questionCounterEl = document.getElementById('question-counter');
        const correctCounterEl = document.getElementById('correct-counter');
        const incorrectCounterEl = document.getElementById('incorrect-counter');
        const feedbackArea = document.getElementById('feedback-area');
        const answerFeedbackEl = document.getElementById('answer-feedback');
        const solutionContainer = document.getElementById('solution-container');
        const solutionTextEl = document.getElementById('solution-text');
        const passageTextEl = document.getElementById('passage-text');
        const passageTextContainer = document.getElementById('passage-text-container');
        const section1Btn = document.getElementById('section-1-btn');
        const section2Btn = document.getElementById('section-2-btn');
        const achievementNotification = document.getElementById('achievement-notification');
        const achievementText = document.getElementById('achievement-text');
        const hintModal = document.getElementById('hint-modal');
        const hintTextEl = document.getElementById('hint-text');
        const closeHintBtn = document.getElementById('close-hint-btn');
        const finalStatsEl = document.getElementById('final-stats');

        let currentQuestionId = null;
        let questionCounter = 0;
        const totalQuestions = 44;
        let correctCount = 0;
        let incorrectCount = 0;
        let incorrectQuestions = [];
        let currentSection = 1;
        let section1Completed = false;

        // Barcha tugmalarga va elementlarga hodisa tinglovchilari qo'shishdan oldin, ularning mavjudligini tekshiramiz.
        // Bu "Cannot read properties of null" xatosini oldini oladi.

        if (checkAnswerBtn) checkAnswerBtn.addEventListener('click', handleCheckAnswer);
        if (nextQuestionBtn) nextQuestionBtn.addEventListener('click', () => loadNextQuestion());
        if (hintBtn) hintBtn.addEventListener('click', handleHint);
        if (markReviewBtn) markReviewBtn.addEventListener('click', handleMarkReview);
        if (retryBtn) retryBtn.addEventListener('click', () => loadNextQuestion());
        if (closeHintBtn) closeHintBtn.addEventListener('click', closeHintModal);

        if (reviewIncorrectBtn) {
            reviewIncorrectBtn.addEventListener('click', () => {
                // Yangi rejimga o'tishda o'zgaruvchilarni qayta o'rnatish
                questionCounter = 0;
                loadNextQuestion(true);
            });
        }
        
        if (section1Btn) section1Btn.addEventListener('click', () => {
            if (currentSection === 1) loadNextQuestion();
        });
        if (section2Btn) section2Btn.addEventListener('click', () => {
            if (currentSection === 2) loadNextQuestion();
        });

        // Modal funksiyalari
        function openHintModal(text) {
            if (hintTextEl && hintModal) {
                hintTextEl.innerHTML = text;
                hintModal.classList.remove('d-none'); // d-none klassini olib tashlash
                if (window.MathJax) {
                    MathJax.typesetPromise([hintTextEl]);
                }
            }
        }

        function closeHintModal() {
            if (hintModal) {
                hintModal.classList.add('d-none');
            }
        }
        
        // Gamifikatsiya xabarnomasi
        function showAchievement(message) {
            if (achievementNotification && achievementText) {
                achievementText.textContent = message;
                achievementNotification.classList.remove('d-none');
                setTimeout(() => {
                    achievementNotification.classList.add('d-none');
                }, 3000);
            }
        }

        // Savolni sahifada ko'rsatish
        function renderQuestion(questionData) {
            if (!questionData || !questionArea) {
                showError("Savol ma'lumotlari topilmadi.");
                return;
            }

            questionCounter++;
            currentQuestionId = questionData.id;
            
            questionNumberEl.textContent = `Savol ${questionCounter} (${currentSection}-bo'lim)`;
            questionTextEl.innerHTML = questionData.question_text;
            
            if (questionData.question_image_url && questionImageContainer && questionImageEl) {
                questionImageEl.src = questionData.question_image_url;
                questionImageContainer.classList.remove('d-none');
            } else if (questionImageContainer) {
                questionImageContainer.classList.add('d-none');
            }
            
            if (questionData.passage_text && passageTextContainer && passageTextEl) {
                passageTextEl.innerHTML = questionData.passage_text;
                passageTextContainer.classList.remove('d-none');
            } else if (passageTextContainer) {
                passageTextContainer.classList.add('d-none');
            }

            if (questionData.question_format === 'short_answer') {
                if (shortAnswerContainer && optionsContainer) {
                    shortAnswerContainer.classList.remove('d-none');
                    optionsContainer.classList.add('d-none');
                    shortAnswerInput.value = '';
                }
            } else {
                if (shortAnswerContainer && optionsContainer) {
                    shortAnswerContainer.classList.add('d-none');
                    optionsContainer.classList.remove('d-none');
                    optionsContainer.innerHTML = questionData.options_html;
                }
            }
            
            // Tugmalarni holatini yangilash
            checkAnswerBtn.disabled = false;
            hintBtn.disabled = false;
            if (markReviewBtn) markReviewBtn.classList.remove('d-none');
            if (nextQuestionBtn) nextQuestionBtn.classList.add('d-none');
            
            // Oldingi xatolarni yashirish
            if (feedbackArea) feedbackArea.classList.add('d-none');
            
            if (window.MathJax) {
                MathJax.typesetPromise([questionTextEl, optionsContainer, passageTextContainer]);
            }
            updateProgress();
            
            // Savol maydonini ko'rsatish
            questionArea.classList.remove('d-none');
        }

        // Progressni yangilash
        function updateProgress() {
            const reviewedCount = correctCount + incorrectCount;
            const progressPercentage = (reviewedCount / totalQuestions) * 100;
            if (progressBar) {
                progressBar.style.width = `${progressPercentage}%`;
                progressBar.setAttribute('aria-valuenow', reviewedCount);
            }
            if (questionCounterEl) questionCounterEl.textContent = `Savollar: ${reviewedCount}/${totalQuestions}`;
            if (correctCounterEl) correctCounterEl.textContent = `To'g'ri: ${correctCount} (${reviewedCount > 0 ? Math.round((correctCount / reviewedCount) * 100) : 0}%)`;
            if (incorrectCounterEl) incorrectCounterEl.textContent = `Noto'g'ri: ${incorrectCount}`;
        }

        // Keyingi savolni yuklash
        function loadNextQuestion(reviewMode = false) {
            loadingArea.classList.remove('d-none');
            questionArea.classList.add('d-none');
            finishedArea.classList.add('d-none');
            errorArea.classList.add('d-none');
            
            const payload = {
                action: reviewMode ? 'get_review_question' : 'get_next_question',
                attempt_id: '{{ attempt.id }}',
                section_attempt_id: '{{ current_section_attempt.id }}',
                current_section: currentSection,
            };
            if (reviewMode) {
                payload.incorrect_questions = incorrectQuestions;
            }

            fetch('{% url "handle_study_ajax" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP xatosi! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                loadingArea.classList.add('d-none');
                if (data.status === 'success') {
                    renderQuestion(data.question_data);
                } else if (data.status === 'section_finished') {
                    if (currentSection === 1) {
                        section1Completed = true;
                        currentSection = 2;
                        section1Btn.disabled = true;
                        section2Btn.disabled = false;
                        loadNextQuestion();
                    } else {
                        showFinalStats();
                        finishedArea.classList.remove('d-none');
                    }
                } else if (data.status === 'finished') {
                    showFinalStats();
                    finishedArea.classList.remove('d-none');
                } else {
                    showError(data.message);
                }
            })
            .catch(error => {
                loadingArea.classList.add('d-none');
                console.error('Fetch error:', error);
                showError('Ulanishda xatolik yuz berdi: ' + error.message);
            });
        }

        // Xatolik ko'rsatish
        function showError(message) {
            if (errorArea && errorMessageEl) {
                errorArea.classList.remove('d-none');
                errorMessageEl.textContent = message;
            }
        }

        // Final statistika ko'rsatish
        function showFinalStats() {
            const reviewedCount = correctCount + incorrectCount;
            const percentage = reviewedCount > 0 ? Math.round((correctCount / reviewedCount) * 100) : 0;
            if (finalStatsEl) {
                finalStatsEl.textContent = `Siz ${reviewedCount} ta savolni ko'rib chiqdingiz. To'g'ri javoblar: ${correctCount} (${percentage}%).`;
            }
            if (percentage >= 80) {
                showAchievement("Ajoyib! Siz 80%+ natija qayd etdingiz!");
            }
            if (incorrectQuestions.length > 0 && reviewIncorrectBtn) {
                reviewIncorrectBtn.classList.remove('d-none');
            }
        }

        // Javobni tekshirish
        function handleCheckAnswer() {
            const format = optionsContainer.classList.contains('d-none') ? 'short_answer' : (document.querySelector('input[type="checkbox"]') ? 'multiple' : 'single');
            
            let selectedData;
            if (format === 'short_answer') {
                selectedData = shortAnswerInput.value;
            } else if (format === 'multiple') {
                selectedData = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(el => parseInt(el.value));
            } else {
                const checkedRadio = document.querySelector('input[type="radio"]:checked');
                selectedData = checkedRadio ? parseInt(checkedRadio.value) : null;
            }

            fetch('{% url "handle_study_ajax" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    action: 'check_answer',
                    attempt_id: '{{ attempt.id }}',
                    section_attempt_id: '{{ current_section_attempt.id }}',
                    question_id: currentQuestionId,
                    selected_options: format === 'multiple' ? selectedData : [],
                    selected_option: format === 'single' ? selectedData : null,
                    short_answer_text: format === 'short_answer' ? selectedData : null,
                    current_section: currentSection,
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const solutionData = data.solution_data;
                    if (feedbackArea) feedbackArea.classList.remove('d-none');
                    if (answerFeedbackEl) answerFeedbackEl.classList.remove('d-none');
                    if (solutionContainer) solutionContainer.classList.remove('d-none');
                    
                    if (solutionData.is_correct) {
                        answerFeedbackEl.classList.remove('alert-danger');
                        answerFeedbackEl.classList.add('alert-success');
                        answerFeedbackEl.textContent = "{% trans 'To'g'ri!' %}";
                        correctCount++;
                        if (correctCount % 5 === 0) {
                            showAchievement(`Zo'r! Siz ${correctCount} ta savolni to'g'ri yechdingiz!`);
                        }
                    } else {
                        answerFeedbackEl.classList.remove('alert-success');
                        answerFeedbackEl.classList.add('alert-danger');
                        answerFeedbackEl.textContent = "{% trans 'Noto'g'ri.' %}";
                        incorrectCount++;
                        if (!incorrectQuestions.includes(currentQuestionId)) {
                             incorrectQuestions.push(currentQuestionId);
                        }
                    }
                    
                    solutionTextEl.innerHTML = solutionData.solution_text;
                    
                    document.querySelectorAll('input[type="radio"], input[type="checkbox"], #short-answer-input').forEach(el => el.disabled = true);
                    
                    if (format === 'multiple' || format === 'single') {
                        document.querySelectorAll('.form-check-input').forEach(input => {
                            if (solutionData.correct_answer_ids.includes(parseInt(input.value))) {
                                input.parentElement.classList.add('bg-success', 'text-white', 'p-2', 'rounded');
                            }
                        });
                    }
                    
                    checkAnswerBtn.classList.add('d-none');
                    hintBtn.classList.add('d-none');
                    markReviewBtn.classList.add('d-none');
                    nextQuestionBtn.classList.remove('d-none');

                    if (window.MathJax) {
                        MathJax.typesetPromise([solutionTextEl]);
                    }

                    updateProgress();
                } else {
                    showError(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Javobni tekshirishda xatolik yuz berdi.');
            });
        }
        
        // Maslahat olish
        function handleHint() {
            fetch('{% url "handle_study_ajax" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    action: 'get_hint',
                    question_id: currentQuestionId,
                    attempt_id: '{{ attempt.id }}',
                    section_attempt_id: '{{ current_section_attempt.id }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    openHintModal(data.hint_text);
                } else {
                    showError(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Maslahat olishda xatolik yuz berdi.');
            });
        }

        // Takrorlash uchun belgilash
        function handleMarkReview() {
            fetch('{% url "handle_study_ajax" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    action: 'mark_for_review',
                    question_id: currentQuestionId,
                    attempt_id: '{{ attempt.id }}',
                    section_attempt_id: '{{ current_section_attempt.id }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAchievement('Savol takrorlash uchun belgilandi.');
                    if (!incorrectQuestions.includes(currentQuestionId)) {
                        incorrectQuestions.push(currentQuestionId);
                    }
                } else {
                    showError(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Savolni belgilashda xatolik yuz berdi.');
            });
        }
        
        // Boshlang'ich yuklash
        loadNextQuestion();
    });
</script>

<style>
    .d-none { display: none !important; }
    .modal { display: none; }
    .modal.hidden { display: none; }
    .modal:not(.hidden) { display: flex; }
    .btn { transition: all 0.2s; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .progress-bar { transition: width 0.5s ease-in-out; }
    .achievement-notification { transition: opacity 0.5s; }
    .grid-cols-1 > div { width: 100%; }
    @media (min-width: 640px) {
        .grid-cols-2 > div { width: 50%; }
    }
</style>
{% endblock extra_js %}