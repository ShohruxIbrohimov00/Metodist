{% extends 'base.html' %}
{% load static %}

{% block title %}Imtihonlar Markazi{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-indigo-50 py-8 px-4">
    <div class="max-w-7xl mx-auto">
        <!-- Sarlavha -->
        <div class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-slate-800 mb-4">
                <span class="bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                    Imtihonlar Markazi
                </span>
            </h1>
            <p class="text-lg text-slate-600 max-w-2xl mx-auto">
                Bilimingizni sinang va SAT imtihoniga professional tayyorlaning.
            </p>
        </div>

        <!-- Qidiruv + Filter -->
        <div class="mt-8 max-w-2xl mx-auto">
            <div class="flex md:flex-row items-center gap-4">
                <div class="flex-1 relative w-full">
                    <input type="text" id="exam-search-input" placeholder="Imtihon nomini qidiring..."
                           class="w-full pl-5 pr-12 py-4 text-lg border-2 border-slate-200 rounded-2xl
                                  focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 transition shadow-sm">
                    <i class="fa-solid fa-search absolute right-5 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                </div>

                <!-- FILTER TUGMASI -->
                <div class="relative">
                    <button id="filter-toggle"
                            class="w-14 h-14 bg-white border-2 border-slate-200 rounded-full shadow-lg
                                   hover:border-indigo-500 hover:bg-indigo-50 transition-all duration-300
                                   flex items-center justify-center relative group">
                        <i class="fa-solid fa-sliders text-indigo-600 text-xl group-hover:scale-110 transition"></i>
                        <span id="filter-indicator" class="absolute -top-1 -right-1 w-5 h-5 bg-gradient-to-br from-emerald-500 to-teal-600 
                              rounded-full border-4 border-white shadow-lg {% if filter_type == 'all' and filter_price == 'all' %}hidden{% endif %} animate-pulse"></span>
                    </button>

                    <!-- FILTER DROPDOWN -->
                    <div id="filter-dropdown"
                         class="fixed md:absolute inset-x-0 md:inset-auto bottom-0 md:bottom-auto md:top-16 md:right-0
                                w-full md:w-96 bg-white rounded-t-3xl md:rounded-2xl shadow-2xl border border-slate-100
                                z-50 overflow-hidden invisible opacity-0 transition-all duration-300 pointer-events-none">

                        <div class="md:hidden w-12 h-1.5 bg-gray-300 rounded-full mx-auto mt-5 mb-4"></div>
                        <div class="hidden md:block absolute -top-3 right-10 w-0 h-0 border-l-8 border-r-8 border-b-8 
                                    border-transparent border-b-white shadow-md"></div>

                        <div class="p-6">
                            <h3 class="text-xl font-extrabold text-slate-800 text-center md:text-left mb-6">Filtrlash</h3>

                            <form method="GET" id="filter-form">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                                    <!-- Imtihon turi -->
                                    <div>
                                        <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Imtihon turi</p>
                                        <div class="space-y-2">
                                            <label class="filter-btn block text-center py-3 px-5 rounded-xl font-bold text-sm cursor-pointer transition-all
                                                          {% if not filter_type or filter_type == 'all' %}bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-md{% else %}bg-slate-100 hover:bg-slate-200 text-slate-700{% endif %}"
                                                   data-group="type" data-value="all">
                                                <input type="radio" name="type" value="all" class="hidden" {% if not filter_type or filter_type == 'all' %}checked{% endif %}>
                                                Barchasi
                                            </label>
                                            <label class="filter-btn block text-center py-3 px-5 rounded-xl font-bold text-sm cursor-pointer transition-all
                                                          {% if filter_type == 'mock' %}bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-md{% else %}bg-slate-100 hover:bg-slate-200 text-slate-700{% endif %}"
                                                   data-group="type" data-value="mock">
                                                <input type="radio" name="type" value="mock" class="hidden" {% if filter_type == 'mock' %}checked{% endif %}>
                                                SAT Mock
                                            </label>
                                            <label class="filter-btn block text-center py-3 px-5 rounded-xl font-bold text-sm cursor-pointer transition-all
                                                          {% if filter_type == 'topic' %}bg-gradient-to-r from-emerald-600 to-teal-600 text-white shadow-md{% else %}bg-slate-100 hover:bg-slate-200 text-slate-700{% endif %}"
                                                   data-group="type" data-value="topic">
                                                <input type="radio" name="type" value="topic" class="hidden" {% if filter_type == 'topic' %}checked{% endif %}>
                                                Mavzu Testi
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Narxi -->
                                    <div>
                                        <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Narxi</p>
                                        <div class="space-y-2">
                                            <label class="filter-btn block text-center py-3 px-5 rounded-xl font-bold text-sm cursor-pointer transition-all
                                                          {% if not filter_price or filter_price == 'all' %}bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-md{% else %}bg-slate-100 hover:bg-slate-200 text-slate-700{% endif %}"
                                                   data-group="price" data-value="all">
                                                <input type="radio" name="price" value="all" class="hidden" {% if not filter_price or filter_price == 'all' %}checked{% endif %}>
                                                Hammasi
                                            </label>
                                            <label class="filter-btn block text-center py-3 px-5 rounded-xl font-bold text-sm cursor-pointer transition-all
                                                          {% if filter_price == 'free' %}bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-md{% else %}bg-slate-100 hover:bg-slate-200 text-slate-700{% endif %}"
                                                   data-group="price" data-value="free">
                                                <input type="radio" name="price" value="free" class="hidden" {% if filter_price == 'free' %}checked{% endif %}>
                                                Bepul
                                            </label>
                                            <label class="filter-btn block text-center py-3 px-5 rounded-xl font-bold text-sm cursor-pointer transition-all
                                                          {% if filter_price == 'premium' %}bg-gradient-to-r from-amber-500 to-orange-600 text-white shadow-md{% else %}bg-slate-100 hover:bg-slate-200 text-slate-700{% endif %}"
                                                   data-group="price" data-value="premium">
                                                <input type="radio" name="price" value="premium" class="hidden" {% if filter_price == 'premium' %}checked{% endif %}>
                                                Premium
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex gap-3 mt-8">
                                    <button type="button" id="clear-filters"
                                            class="flex-1 py-3.5 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 rounded-xl font-bold text-sm hover:shadow transition">
                                        Tozalash
                                    </button>
                                    <button type="submit"
                                            class="flex-1 py-3.5 bg-gradient-to-r from-rose-600 to-pink-600 text-white rounded-xl font-bold text-sm shadow-lg hover:shadow-xl transform hover:scale-[1.03] transition">
                                        Qo‘llash
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full h-px bg-blue-200 my-4"></div>

        <!-- Imtihonlar bo‘limlari (avvalgidek, hech narsa o‘zgarmagan) -->
        {% if new_exams or all_exams or popular_exams %}
            {% if new_exams %}
            <section class="exam-section mb-12">
                <div class="flex items-center gap-3 mb-4 px-4 md:px-0">
                    <h2 class="text-2xl font-bold text-slate-800">Yangi Qo'shilgan</h2>
                    <span class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold 
                                bg-gradient-to-r from-emerald-100 to-teal-100 text-teal-800 
                                border border-teal-200">
                        <i class="fas fa-bolt text-teal-700 text-m"></i>
                        <span class="tracking-tight"> {{ new_exams|length }} ta </span>
                    </span>
                </div>
                <div class="horizontal-scroll flex gap-6 pb-4 -mb-4 items-start overflow-x-auto whitespace-nowrap mx-[-1rem] md:mx-0 px-4 md:px-0">
                    {% for exam_data in new_exams %}
                        {% include 'partials/exam_card.html' with exam_data=exam_data %}
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            {% if all_exams %}
            <section class="exam-section mb-12">
                <div class="flex items-center gap-3 mb-4 px-4 md:px-0">
                    <h2 class="text-2xl font-bold text-slate-800">Barcha Imtihonlar</h2>
                    <span class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold 
                                bg-gradient-to-r from-emerald-100 to-teal-100 text-teal-800 
                                border border-teal-200">
                        <i class="fas fa-file-pen text-teal-700 text-m"></i>
                        <span class="tracking-tight">{{ all_exams|length }} ta </span>
                    </span>
                </div>
                <div class="horizontal-scroll flex gap-6 pb-4 -mb-4 items-start overflow-x-auto whitespace-nowrap mx-[-1rem] md:mx-0 px-4 md:px-0">
                    {% for exam_data in all_exams %}
                        {% include 'partials/exam_card.html' with exam_data=exam_data %}
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            {% if popular_exams %}
            <section class="exam-section mb-12">
                <div class="flex items-center gap-3 mb-4 px-4 md:px-0">
                    <h2 class="text-2xl font-bold text-slate-800">Eng Ko'p Ishlangan</h2>
                    <span class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold 
                                bg-gradient-to-r from-emerald-100 to-teal-100 text-teal-800 
                                border border-teal-200">
                        <i class="fa-solid fa-fire text-teal-700 text-m"></i>
                        <span class="tracking-tight">{{ popular_exams|length }} ta </span>
                    </span>
                </div>
                <div class="horizontal-scroll flex gap-6 pb-4 -mb-4 items-start overflow-x-auto whitespace-nowrap mx-[-1rem] md:mx-0 px-4 md:px-0">
                    {% for exam_data in popular_exams %}
                        {% include 'partials/exam_card.html' with exam_data=exam_data %}
                    {% endfor %}
                </div>
            </section>
            {% endif %}
        {% else %}
            <div class="text-center py-20">
                <div class="bg-white/70 backdrop-blur rounded-3xl p-12 max-w-md mx-auto shadow-xl">
                    <i class="fa-solid fa-magnifying-glass text-6xl text-slate-300 mb-6"></i>
                    <p class="text-2xl font-bold text-slate-700">Hech narsa topilmadi</p>
                    <p class="text-slate-500 mt-2">Boshqa filtr yoki qidiruvni sinab ko‘ring</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // CSRF token olish funksiyasi
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    const centerSlug = '{{ center.slug|escapejs }}';

    // === YANGI: "Testni Boshlash" tugmasi uchun AJAX ===
    document.querySelectorAll('.start-exam-btn').forEach(btn => {
        btn.addEventListener('click', async function (e) {
            e.preventDefault();
            const examId = this.dataset.examId;
            if (!examId) return;

            const originalText = this.querySelector('.btn-text').textContent;
            const spinner = this.querySelector('i.fa-spinner');
            const textSpan = this.querySelector('.btn-text');

            // Tugmani bloklash
            this.disabled = true;
            textSpan.textContent = 'Yuklanmoqda...';
            spinner.classList.remove('hidden');

            try {
                const response = await fetch(`/${centerSlug}/exams/${examId}/start/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (response.ok && data.status === 'success' && data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    alert(data.message || 'Xatolik yuz berdi. Qayta urining.');
                    this.disabled = false;
                    textSpan.textContent = originalText;
                    spinner.classList.add('hidden');
                }
            } catch (err) {
                console.error('Xato:', err);
                alert('Internet aloqasi bilan muammo bor yoki server javob bermadi.');
                this.disabled = false;
                textSpan.textContent = originalText;
                spinner.classList.add('hidden');
            }
        });
    });

    // === Qolgan barcha JS (filtr, qidiruv, dropdown) avvalgidek ishlaydi ===
    const toggleBtn   = document.getElementById('filter-toggle');
    const dropdown    = document.getElementById('filter-dropdown');
    const indicator   = document.getElementById('filter-indicator');
    const form        = document.getElementById('filter-form');
    const clearBtn    = document.getElementById('clear-filters');

    toggleBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = !dropdown.classList.contains('invisible');
        if (isOpen) {
            closeDropdown();
        } else {
            dropdown.classList.remove('invisible', 'opacity-0', 'pointer-events-none');
            dropdown.classList.add('opacity-100', 'pointer-events-auto');
            dropdown.style.transform = 'translateY(0)';
            if (window.innerWidth < 768) document.body.style.overflow = 'hidden';
        }
    });

    function closeDropdown() {
        dropdown.classList.add('opacity-0', 'pointer-events-none');
        dropdown.style.transform = 'translateY(100%)';
        setTimeout(() => {
            dropdown.classList.add('invisible');
            document.body.style.overflow = '';
        }, 300);
    }

    document.addEventListener('click', (e) => {
        if (!toggleBtn.contains(e.target) && !dropdown.contains(e.target)) {
            closeDropdown();
        }
    });

    form.addEventListener('submit', () => setTimeout(closeDropdown, 100));

    // Filtr tugmalar
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.stopPropagation();
            const group = this.dataset.group;
            const value = this.dataset.value;

            document.querySelectorAll(`.filter-btn[data-group="${group}"]`).forEach(b => {
                b.classList.remove('text-white', 'shadow-md');
                b.classList.add('bg-slate-100', 'hover:bg-slate-200', 'text-slate-700');
                b.classList.remove('bg-gradient-to-r','from-indigo-600','to-purple-600','from-blue-600','to-cyan-600','from-emerald-600','to-teal-600',
                    'from-purple-600','to-pink-600','from-emerald-500','to-green-600','from-amber-500','to-orange-600');
            });

            this.classList.add('text-white', 'shadow-md');
            this.classList.remove('bg-slate-100', 'text-slate-700');

            if (group === 'type') {
                if (value === 'all')   this.classList.add('bg-gradient-to-r','from-indigo-600','to-purple-600');
                if (value === 'mock')  this.classList.add('bg-gradient-to-r','from-blue-600','to-cyan-600');
                if (value === 'topic') this.classList.add('bg-gradient-to-r','from-emerald-600','to-teal-600');
            } else if (group === 'price') {
                if (value === 'all')     this.classList.add('bg-gradient-to-r','from-purple-600','to-pink-600');
                if (value === 'free')    this.classList.add('bg-gradient-to-r','from-emerald-500','to-green-600');
                if (value === 'premium') this.classList.add('bg-gradient-to-r','from-amber-500','to-orange-600');
            }

            this.querySelector('input[type="radio"]').checked = true;

            const typeVal  = document.querySelector('input[name="type"]:checked').value;
            const priceVal = document.querySelector('input[name="price"]:checked').value;
            indicator.classList.toggle('hidden', typeVal === 'all' && priceVal === 'all');
        });
    });

    clearBtn.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('input[name="type"], input[name="price"]').forEach(i => i.checked = i.value === 'all');
        location.href = location.pathname;
    });

    // Qidiruv
    document.getElementById('exam-search-input')?.addEventListener('input', function () {
        const query = this.value.toLowerCase().trim();
        document.querySelectorAll('.exam-card').forEach(card => {
            const title = (card.querySelector('h3')?.textContent || '').toLowerCase();
            card.style.display = title.includes(query) ? '' : 'none';
        });
    });
});
</script>
{% endblock %}
