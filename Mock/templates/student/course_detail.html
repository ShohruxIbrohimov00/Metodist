{% extends 'base.html' %}
{% load static %}

{% block title %}{{ course.title }} - Kurs haqida{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-indigo-50 py-8 md:py-16">
    <div class="container mx-auto px-4 max-w-7xl">
        
        {# ASOSIY GRID LAYOUT #}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            {# ============================================ #}
            {# CHAP KONTENT (2/3) #}
            {# ============================================ #}
            <div class="lg:col-span-2 space-y-8">
                
                {# KURS HEADER #}
                {# ZAMONAVIY KURS HEADER - 2025 STYLE #}
                <div class="relative overflow-hidden bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-3xl shadow-2xl border border-white/20">
                    <!-- Orqa fon effektlari -->
                    <div class="absolute inset-0 bg-black/20"></div>
                    <div class="absolute -top-24 -right-24 w-72 h-72 bg-purple-400/30 rounded-full blur-3xl"></div>
                    <div class="absolute -bottom-32 -left-20 w-96 h-96 bg-pink-400/30 rounded-full blur-3xl"></div>

                    <div class="relative p-8 md:p-12 lg:p-14">
                        <!-- Kurs sarlavhasi -->
                        <h1 class="text-4xl md:text-5xl lg:text-6xl font-black text-white mb-6 leading-tight drop-shadow-2xl">
                            {{ course.title }}
                        </h1>

                        <!-- Kurs tavsifi -->
                        <p class="text-lg md:text-xl text-white/90 leading-relaxed max-w-4xl drop-shadow-lg">
                            {{ course.description|default:"Bu kurs sizni yangi darajaga olib chiqadi – professional bilim va amaliy tajribalar bilan to‘ldirilgan." }}
                        </p>

                        {# KURS BADGES – YANGI ZAMONAVIY USLUB #}
                        <div class="flex flex-wrap items-center gap-4 mt-10">
                            <!-- O'quvchilar soni -->
                            <div class="group flex items-center gap-3 bg-white/20 backdrop-blur-md px-6 py-4 rounded-2xl border border-white/30 hover:bg-white/30 transition-all duration-300">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-400 to-purple-400 flex items-center justify-center shadow-lg">
                                    <i class="fas fa-users text-white text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-white/70 text-xs font-medium">O'quvchilar</p>
                                    <p class="text-2xl font-bold text-white">{{ students_count|default:"1000+" }}</p>
                                </div>
                            </div>

                            <!-- Darslar soni -->
                            <div class="group flex items-center gap-3 bg-white/20 backdrop-blur-md px-6 py-4 rounded-2xl border border-white/30 hover:bg-white/30 transition-all duration-300">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-400 to-teal-400 flex items-center justify-center shadow-lg">
                                    <i class="fas fa-play-circle text-white text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-white/70 text-xs font-medium">Darslar</p>
                                    <p class="text-2xl font-bold text-white">{{ total_lessons_count|default:"50+" }}</p>
                                </div>
                            </div>

                            <!-- Premium kurs -->
                            {% if course.is_premium %}
                            <div class="flex items-center gap-3 bg-gradient-to-r from-amber-400 to-orange-500 px-7 py-4 rounded-2xl shadow-xl transform hover:scale-105 transition-all duration-300">
                                <i class="fas fa-crown text-white text-2xl"></i>
                                <span class="text-white font-black text-lg tracking-wider">PREMIUM</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                {# KURS STATISTIKASI #}
                <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6 md:p-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <i class="fas fa-chart-pie text-indigo-600"></i>
                        Kurs tarkibi
                    </h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {# VIDEO DARSLAR #}
                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl border-2 border-red-200 text-center transition-transform hover:scale-105">
                            <div class="w-12 h-12 mx-auto mb-2 bg-red-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-play text-white text-xl"></i>
                            </div>
                            <p class="text-3xl font-extrabold text-red-700 mb-1">{{ total_videos_count }}</p>
                            <p class="text-xs font-medium text-red-800">Video darslar</p>
                        </div>
                        
                        {# VAZIFALAR #}
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl border-2 border-orange-200 text-center transition-transform hover:scale-105">
                            <div class="w-12 h-12 mx-auto mb-2 bg-orange-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-tasks text-white text-xl"></i>
                            </div>
                            <p class="text-3xl font-extrabold text-orange-700 mb-1">{{ total_tasks_count }}</p>
                            <p class="text-xs font-medium text-orange-800">Amaliy vazifalar</p>
                        </div>
                        
                        {# YECHIM VIDEOLAR #}
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-xl border-2 border-amber-200 text-center transition-transform hover:scale-105">
                            <div class="w-12 h-12 mx-auto mb-2 bg-amber-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-laptop-code text-white text-xl"></i>
                            </div>
                            <p class="text-3xl font-extrabold text-amber-700 mb-1">{{ total_solution_videos_count }}</p>
                            <p class="text-xs font-medium text-amber-800">Yechim videolar</p>
                        </div>
                        
                        {# FAYLLAR #}
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border-2 border-blue-200 text-center transition-transform hover:scale-105">
                            <div class="w-12 h-12 mx-auto mb-2 bg-blue-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-file-download text-white text-xl"></i>
                            </div>
                            <p class="text-3xl font-extrabold text-blue-700 mb-1">{{ total_files_count }}</p>
                            <p class="text-xs font-medium text-blue-800">Yechim fayllar</p>
                        </div>
                        
                        {# TESTLAR #}
                        <div class="bg-gradient-to-br from-violet-50 to-violet-100 p-4 rounded-xl border-2 border-violet-200 text-center transition-transform hover:scale-105 md:col-span-2">
                            <div class="w-12 h-12 mx-auto mb-2 bg-violet-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-clipboard-check text-white text-xl"></i>
                            </div>
                            <p class="text-3xl font-extrabold text-violet-700 mb-1">{{ total_exams_count }}</p>
                            <p class="text-xs font-medium text-violet-800">Imtihon testlar</p>
                        </div>
                        
                        {# BOSHQA RESURSLAR #}
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border-2 border-purple-200 text-center transition-transform hover:scale-105 md:col-span-2">
                            <div class="w-12 h-12 mx-auto mb-2 bg-purple-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-link text-white text-xl"></i>
                            </div>
                            <p class="text-3xl font-extrabold text-purple-700 mb-1">{{ total_other_resources_count }}</p>
                            <p class="text-xs font-medium text-purple-800">Qo'shimcha resurslar</p>
                        </div>
                    </div>
                </div>
                
                {# KURS DASTURI (ROADMAP) #}
                <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6 md:p-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <i class="fas fa-list-check text-indigo-600"></i>
                        Kurs dasturi
                    </h2>
                    
                    {% if roadmap_data %}
                        <div class="space-y-4" x-data="{ activeModule: 1 }">
                            {% for module_data in roadmap_data %}
                            
                            <div class="border border-gray-200 rounded-xl overflow-hidden transition-all duration-300 hover:shadow-lg"
                                 x-data="{ open: {{ forloop.counter }} === 1 }">
                                
                                {# MODULE HEADER #}
                                <div class="p-4 cursor-pointer select-none transition-colors"
                                     :class="open ? 'bg-indigo-50 border-l-4 border-l-indigo-500' : 'bg-white hover:bg-gray-50'"
                                     @click="open = !open">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-4 flex-grow">
                                            <i class="fas fa-chevron-right text-gray-500 transition-transform duration-300"
                                               :class="{ 'rotate-90 text-indigo-600': open }"></i>
                                            
                                            <div>
                                                <h3 class="text-lg font-bold text-slate-800">
                                                    <span class="text-indigo-600">{{ module_data.module.order }}.</span> 
                                                    {{ module_data.module.title }}
                                                </h3>
                                                {% if module_data.module.description %}
                                                    <p class="text-sm text-slate-600 mt-1">{{ module_data.module.description|truncatewords:15 }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <span class="text-sm font-semibold text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                                            {{ module_data.lessons|length }} dars
                                        </span>
                                    </div>
                                </div>
                                
                                {# MODULE LESSONS #}
                                <div x-show="open" x-collapse.duration.300ms>
                                    <ul class="divide-y divide-gray-100 bg-gray-50">
                                        {% for lesson_data in module_data.lessons %}
                                        
                                        <li class="p-4 flex items-center justify-between hover:bg-indigo-50/50 transition-colors">
                                            <div class="flex items-center gap-3 flex-grow">
                                                <div class="w-8 h-8 flex items-center justify-center flex-shrink-0">
                                                    {% if lesson_data.lesson.has_exam %}
                                                        <div class="w-7 h-7 bg-red-100 rounded-full flex items-center justify-center">
                                                            <i class="fas fa-clipboard-check text-red-600 text-sm"></i>
                                                        </div>
                                                    {% else %}
                                                        <div class="w-7 h-7 bg-indigo-100 rounded-full flex items-center justify-center">
                                                            <i class="fas fa-circle-play text-indigo-600 text-sm"></i>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                
                                                <span class="text-base font-medium text-gray-800">
                                                    {{ lesson_data.lesson.order }}. {{ lesson_data.lesson.title }}
                                                </span>
                                            </div>
                                            
                                            {# LESSON RESOURCE ICONS #}
                                            <div class="flex items-center gap-3 ml-4">
                                                {% if lesson_data.has_video %}
                                                    <i class="fas fa-play-circle text-red-500" title="Video dars"></i>
                                                {% endif %}
                                                {% if lesson_data.has_task %}
                                                    <i class="fas fa-tasks text-orange-500" title="Amaliy vazifa"></i>
                                                {% endif %}
                                                {% if lesson_data.has_solution_video %}
                                                    <i class="fas fa-laptop-code text-amber-500" title="Yechim video"></i>
                                                {% endif %}
                                                {% if lesson_data.has_file %}
                                                    <i class="fas fa-file-download text-blue-500" title="Yuklab olish"></i>
                                                {% endif %}
                                                {% if lesson_data.lesson.has_exam %}
                                                    <i class="fas fa-clipboard-check text-violet-500" title="Test"></i>
                                                {% endif %}
                                            </div>
                                        </li>
                                        
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="py-12 text-center border-2 border-dashed border-gray-300 rounded-xl bg-gray-50">
                            <i class="fas fa-folder-open text-5xl text-gray-300 mb-3"></i>
                            <p class="text-lg font-medium text-gray-500">Kurs dasturi hali tayyorlanmoqda</p>
                        </div>
                    {% endif %}
                </div>
                
            </div>
            
            {# ============================================ #}
            {# O'NG SIDEBAR - TO'LIQ STICKY BLOK #}
            {# ============================================ #}
            <div class="lg:col-span-1">

                {# Sticky bo'ladigan BUTUN blok shu joyda boshlanadi #}
                <div class="lg:sticky lg:top-[80px] space-y-6 z-10 bg-transparent">

                    {# 1. NARX VA CTA #}
                    <div class="bg-white rounded-2xl shadow-2xl border border-indigo-200 overflow-hidden">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-slate-800 mb-4 pb-3 border-b">Kursga kirish</h3>
                            
                            <div class="mb-6">
                                <div class="text-4xl font-extrabold text-indigo-600 mb-2">
                                    {% if course.price > 0 %}
                                        {{ course.price|floatformat:0 }} so'm
                                    {% else %}
                                        BEPUL
                                    {% endif %}
                                </div>
                                <p class="text-sm text-gray-500">Barcha materiallar va testlarga kirish</p>
                            </div>

                            {# CTA BUTTONS #}
                            {% if request.user.is_authenticated %}
                                {% if is_enrolled %}
                                    {# 1. Yozilgan (ENROLLED) bo'lsa #}
                                    <a href="{% url 'course_roadmap' center.slug course.id %}" 
                                    class="block w-full text-center px-6 py-4 text-lg font-bold text-white bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all shadow-lg shadow-green-300/50 mb-3">
                                        <i class="fas fa-play mr-2"></i>Darslarni boshlash
                                    </a>
                                    <p class="text-center text-sm text-green-600 font-medium">
                                        <i class="fas fa-check-circle mr-1"></i>Siz kurs talabasisiz
                                    </p>
                                {% else %}
                                    {# 2. Yozilmagan (NOT ENROLLED) bo'lsa #}
                                    <a href="{% url 'course_enroll' center.slug course.id %}" 
                                    class="block w-full text-center px-6 py-4 text-lg font-bold text-white bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all shadow-xl shadow-indigo-300/50 mb-3">
                                        {% if course.price > 0 or course.is_premium %}
                                            {# PULLIK KURSGA YO'NALTIRISH TUGMASI #}
                                            <i class="fas fa-money-bill-wave mr-2"></i>To'lov qilish
                                        {% else %}
                                            {# BEPUL KURSGA YOZILISH TUGMASI #}
                                            <i class="fas fa-user-plus mr-2"></i>Kursga yozilish (BEPUL)
                                        {% endif %}
                                    </a>
                                    {% if course.price > 0 or course.is_premium %}
                                        <p class="text-center text-sm text-gray-500">To'lovdan so'ng guruhga qo'shilasiz</p>
                                    {% else %}
                                        <p class="text-center text-sm text-gray-500">Bir daqiqada ro'yxatdan o'ting</p>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                {# 3. Autentifikatsiyadan o'tmagan (NOT LOGGED IN) bo'lsa #}
                                <a href="{% url 'login' %}?next={{ request.path }}" 
                                class="block w-full text-center px-6 py-4 text-lg font-bold text-white bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all shadow-xl shadow-indigo-300/50 mb-3">
                                    <i class="fas fa-sign-in-alt mr-2"></i>Kirish
                                </a>
                                <p class="text-center text-sm text-gray-500">Avval tizimga kiring</p>
                            {% endif %}
                        </div>
                    </div>

                    {# 2. O'QITUVCHI #}
                    {% if teacher_info %}
                    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-4 pb-3 border-b">Kurs o'qituvchisi</h3>
                        
                        <div class="flex items-center gap-4 mb-4">
                            <img class="w-16 h-16 rounded-full object-cover border-4 border-indigo-100" 
                                src="{% if teacher_info.profile_picture %}{{ teacher_info.profile_picture.url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}" 
                                alt="{{ teacher_info.full_name|default:teacher_info.username }}"
                                onerror="this.src='{% static 'images/default_avatar.png' %}'">
                            <div>
                                <p class="text-lg font-bold text-slate-900">{{ teacher_info.full_name|default:teacher_info.username }}</p>
                                <p class="text-sm text-indigo-600 font-medium"><i class="fas fa-chalkboard-teacher mr-1"></i>Mentor</p>
                            </div>
                        </div>
                        
                        {% if teacher_info.bio %}
                            <p class="text-sm text-slate-600 leading-relaxed">{{ teacher_info.bio|truncatewords:30 }}</p>
                        {% endif %}
                    </div>
                    {% endif %}

                    {# 3. KURS AFZALLIKLARI #}
                    <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl shadow-lg border border-indigo-200 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">
                            <i class="fas fa-star text-amber-500 mr-2"></i>Kurs afzalliklari
                        </h3>
                        <ul class="space-y-3">
                            <li class="flex items-start gap-3"><i class="fas fa-check-circle text-green-600 mt-0.5"></i><span class="text-sm text-slate-700">Amaliy loyihalar bilan o'rganish</span></li>
                            <li class="flex items-start gap-3"><i class="fas fa-check-circle text-green-600 mt-0.5"></i><span class="text-sm text-slate-700">Har bir darsdan keyin test topshirish</span></li>
                            <li class="flex items-start gap-3"><i class="fas fa-check-circle text-green-600 mt-0.5"></i><span class="text-sm text-slate-700">Vazifalar yechimi videolar</span></li>
                            <li class="flex items-start gap-3"><i class="fas fa-check-circle text-green-600 mt-0.5"></i><span class="text-sm text-slate-700">Qo'shimcha materiallar</span></li>
                            <li class="flex items-start gap-3"><i class="fas fa-check-circle text-green-600 mt-0.5"></i><span class="text-sm text-slate-700">Progressni kuzatish imkoniyati</span></li>
                        </ul>
                    </div>

                </div>
                {# Sticky blok shu yerda tugaydi #}
            </div>
            
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}