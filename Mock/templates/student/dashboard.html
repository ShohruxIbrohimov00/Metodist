{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Boshqaruv Paneli{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-indigo-50 py-8 px-4">
    <div class="max-w-7xl mx-auto">
        {# 1. Sarlavha Qismi (o'zgarishsiz) #}
        <div class="text-center mb-8 md:mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-slate-800 mb-4">
                <span class="bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                    Xush kelibsiz, {{ user.first_name|default:user.username }}!
                </span>
            </h1>
            <p class="text-lg text-slate-600 max-w-2xl mx-auto">
                {{ CENTER_NAME }} platformasidagi eng sifatli kurslar. Obuna orqali cheklanmagan kirish huquqiga ega bo‘ling!
            </p>
        </div>

        {# 2. Asosiy Kontent (3 ustunli layout) #}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
            
            {# Chap va Markaziy Qism (lg:col-span-2) #}
            <div class="lg:col-span-2 space-y-6 md:space-y-8">

                {# Aqlli Kun Tartibi #}
                <div class="bg-white p-5 md:p-8 rounded-2xl shadow-xl border-2 border-indigo-300">
                    <h3 class="text-lg md:text-xl font-bold text-slate-800 mb-4 md:mb-6 flex items-center gap-2">
                        <i class="fas fa-clipboard-list text-indigo-600"></i>
                        Aqlli Kun Tartibi
                    </h3>
                    <div class="space-y-3 md:space-y-4">
                        {% for item in agenda_items %}
                            <a href="{{ item.url }}" class="flex items-center gap-3 md:gap-4 p-3 md:p-4 bg-slate-50 rounded-xl hover:bg-indigo-50 hover:shadow-md transition-all duration-300 group">
                                <div class="flex-shrink-0 w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br 
                                    {% if item.color == 'teal' %}from-teal-500 to-cyan-600
                                    {% elif item.color == 'red' %}from-red-500 to-pink-600
                                    {% elif item.color == 'orange' %}from-amber-500 to-orange-600
                                    {% elif item.color == 'green' %}from-green-500 to-emerald-600
                                    {% elif item.color == 'purple' %}from-purple-500 to-fuchsia-600
                                    {% else %}from-indigo-500 to-purple-600{% endif %} 
                                    rounded-xl flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition-transform">
                                    {# Django views.py dagi 'icon' kalitiga moslash uchun to'g'ri 'fas' ikonkalari ishlatildi #}
                                    {% if item.icon == 'brain' %}<i class="fas fa-brain text-lg md:text-xl"></i>
                                    {% elif item.icon == 'chart' %}<i class="fas fa-chart-line text-lg md:text-xl"></i>
                                    {% elif item.icon == 'rocket' %}<i class="fas fa-rocket text-lg md:text-xl"></i>
                                    {% elif item.icon == 'graduation-cap' %}<i class="fas fa-graduation-cap text-lg md:text-xl"></i>
                                    {% elif item.icon == 'book' %}<i class="fas fa-book text-lg md:text-xl"></i>
                                    {% else %}<i class="fas fa-star text-lg md:text-xl"></i>
                                    {% endif %}
                                </div>
                                <div class="flex-grow min-w-0">
                                    <p class="font-bold text-sm md:text-base text-slate-800 truncate">{{ item.title }}</p>
                                    <p class="text-xs md:text-sm text-slate-500 truncate">{{ item.description }}</p>
                                </div>
                                <i class="fas fa-chevron-right text-slate-400 group-hover:text-indigo-600 transition-colors"></i>
                            </a>
                        {% empty %}
                            <div class="text-center py-8 md:py-12">
                                <i class="fas fa-check-circle text-5xl md:text-6xl text-green-500 mb-3"></i>
                                <p class="text-slate-600 font-medium">Hozircha siz uchun vazifalar yo'q. Ajoyib!</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                {# --- YANGI BLOK: Aktiv Kurslar Progressi (Minimalistik) --- #}
                
                {# Faqat 100% dan kam bajarilgan kurslar mavjud bo'lsa ko'rsatiladi #}
                {% with active_courses=course_progress_data|filter_active_courses %}
                {% if active_courses %}
                <div class="bg-white p-5 md:p-8 rounded-2xl shadow-xl border-2 border-indigo-300">
                    <h3 class="text-lg md:text-xl font-bold text-slate-800 mb-4 md:mb-6 flex items-center gap-2">
                        <i class="fas fa-book-open-reader text-indigo-600"></i>
                        Faol Kurslaringiz
                    </h3>
                    <div class="space-y-5">
                        {% for data in active_courses %}
                            <div class="group relative bg-slate-50 rounded-xl p-4 md:p-5 border border-slate-200 hover:border-indigo-400 hover:shadow-lg transition-all duration-300">
                                
                                <div class="flex items-center justify-between gap-4 mb-3">
                                    <a href="{% url 'course_detail' center.slug data.course.pk %}" 
                                    class="flex-1 text-base md:text-lg font-bold text-slate-800 hover:text-indigo-600 transition-colors line-clamp-1 leading-tight">
                                        {{ data.course.title }}
                                    </a>
                                    <div class="flex-shrink-0 text-right">
                                        <div class="text-2xl font-black text-indigo-600">{{ data.progress_percent }}%</div>
                                    </div>
                                </div>

                                <div class="relative w-full bg-slate-200 rounded-full h-3 overflow-hidden shadow-inner mb-4">
                                    <div class="absolute inset-0 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all duration-1000 ease-out"
                                        style="width: {{ data.progress_percent }}%"></div>
                                </div>

                                {% if data.next_lesson %}
                                    <a href="{% url 'lesson_detail' slug=center.slug lesson_id=data.next_lesson.id %}"
                                    class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg text-sm shadow-md hover:bg-indigo-700 transform hover:scale-[1.01] transition-all duration-200 group-hover:shadow-lg">
                                        <i class="fas fa-play text-xs"></i>
                                        Davom ettirish: <span class="opacity-90 font-normal ml-1">{{ data.next_lesson.title|truncatechars:20 }}</span>
                                        <i class="fas fa-arrow-right text-xs ml-auto"></i>
                                    </a>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% elif course_progress_data and not active_courses %}
                {# Barcha kurslar tugallangan holat uchun – Agar toza kurs ro'yxati bo'lsa chiqmaydi #}
                <div class="bg-white p-5 md:p-8 rounded-2xl shadow-xl border-2 border-green-300">
                    <div class="text-center py-8">
                        <i class="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>
                        <h4 class="text-xl font-bold text-slate-700 mb-2">Barcha kurslar muvaffaqiyatli tugallandi!</h4>
                        <p class="text-slate-500 mb-6">Siz ajoyib natija ko'rsatdingiz. Yangi kurslarni kashf eting.</p>
                        <a href="{% url 'all_courses' center.slug %}"
                            class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-green-500 to-teal-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
                            <i class="fas fa-compass"></i>
                            Yangi Kurslarni Ko‘rish
                        </a>
                    </div>
                </div>
                {% else %}
                    {# Kurslar ro'yxati umuman bo'sh bo'lsa (bu holatda ham bu blok chiqmasligi kerak) #}
                    {# Bu yerga hech narsa qo'ymaymiz, chunki talabga ko'ra butun blok ko'rinmasligi kerak #}
                {% endif %}
                {% endwith %}
                {# --- YANGI BLOK TUGADI --- #}

                {# Haftalik Progress Chart (o'zgarishsiz) #}
                <div class="bg-white p-5 md:p-8 rounded-2xl shadow-xl border-2 border-indigo-300">
                    <h3 class="text-lg md:text-xl font-bold text-slate-800 mb-4 md:mb-6 flex items-center gap-2">
                        <i class="fas fa-chart-area text-indigo-600"></i>
                        Haftalik Progress
                    </h3>
                    <div class="h-64 md:h-80 lg:h-96">
                        <canvas id="weeklyProgressChart"></canvas>
                    </div>
                </div>
            </div>

            {# O'ng Tomon (sidebar) (o'zgarishsiz) #}
            <div class="space-y-6 md:space-y-8">
                {# Liderlar Doskasi #}
                <div class="bg-white p-5 md:p-6 rounded-2xl shadow-xl border-2 border-yellow-300">
                    <h3 class="text-lg md:text-xl font-bold text-slate-800 mb-4 md:mb-6 flex items-center gap-2">
                        <i class="fas fa-trophy text-yellow-500"></i>
                        Liderlar Doskasi
                    </h3>
                    <ul class="space-y-2 md:space-y-3">
                        {% for player in leaderboard_users %}
                        <li class="flex items-center gap-2 md:gap-3 p-2 md:p-3 rounded-xl transition-all 
                            {% if player.id == user.id %}
                                bg-gradient-to-r from-indigo-100 to-purple-100 ring-2 ring-indigo-300 shadow-md
                            {% else %}
                                hover:bg-slate-50
                            {% endif %}">
                            
                            <span class="flex-shrink-0 w-7 h-7 md:w-8 md:h-8 rounded-full flex items-center justify-center font-bold text-xs md:text-sm
                                {% if forloop.counter == 1 %}bg-yellow-500 text-white
                                {% elif forloop.counter == 2 %}bg-slate-400 text-white
                                {% elif forloop.counter == 3 %}bg-amber-600 text-white
                                {% else %}bg-slate-200 text-slate-600{% endif %}">
                                {{ forloop.counter }}
                            </span>

                            <div class="flex-grow flex items-center justify-between gap-2 min-w-0">
                                <p class="font-semibold text-sm md:text-base text-slate-800 truncate min-w-0 flex-grow">
                                    {{ player.get_full_name|default:player.username }}
                                </p>
                                
                                <span class="flex-shrink-0 font-extrabold text-base md:text-lg text-indigo-600 whitespace-nowrap">
                                    {{ player.completed_score }} 
                                </span>
                            </div>
                        </li>
                        {% empty %}
                        <p class="text-sm text-slate-500 text-center py-6">Hozircha liderlar yo'q.</p>
                        {% endfor %}
                    </ul>

                    {% if user_rank and user_rank > 5 %}
                    <div class="mt-4 md:mt-6 pt-4 border-t-2 border-dashed border-slate-200 text-center">
                        <p class="text-xs md:text-sm font-semibold text-slate-500 mb-1">Sizning o'rningiz:</p>
                        <div class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-100 rounded-full">
                            <i class="fas fa-medal text-indigo-600 text-lg"></i>
                            <span class="text-2xl font-bold text-indigo-700">{{ user_rank }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>

                {# Umumiy Ko'rsatkichlar #}
                <div class="bg-white p-5 md:p-6 rounded-2xl shadow-xl border-2 border-yellow-300">
                    <h3 class="text-lg md:text-xl font-bold text-slate-800 mb-4 md:mb-6 flex items-center gap-2">
                        <i class="fas fa-chart-pie text-indigo-600"></i>
                        Umumiy Ko'rsatkichlar
                    </h3>
                    <div class="space-y-4 md:space-y-5">
                        <div class="flex items-center gap-3 md:gap-4 p-3 md:p-4 bg-gradient-to-r from-yellow-50 to-amber-50 rounded-xl">
                            <div class="flex-shrink-0 w-12 h-12 md:w-14 md:h-14 bg-yellow-500 rounded-xl flex items-center justify-center shadow-lg">
                                <i class="fas fa-trophy text-white text-xl md:text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-2xl md:text-3xl font-bold text-slate-800">{{ highest_score }}</p>
                                <p class="text-xs md:text-sm font-semibold text-slate-500">Eng Yuqori Ball</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 md:gap-4 p-3 md:p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl">
                            <div class="flex-shrink-0 w-12 h-12 md:w-14 md:h-14 bg-green-500 rounded-xl flex items-center justify-center shadow-lg">
                                <i class="fas fa-pen-alt text-white text-xl md:text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-2xl md:text-3xl font-bold text-slate-800">{{ completed_exam_count }}</p>
                                <p class="text-xs md:text-sm font-semibold text-slate-500">Topshirilgan Imtihon</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 md:gap-4 p-3 md:p-4 bg-gradient-to-r from-sky-50 to-blue-50 rounded-xl">
                            <div class="flex-shrink-0 w-12 h-12 md:w-14 md:h-14 bg-sky-500 rounded-xl flex items-center justify-center shadow-lg">
                                <i class="fas fa-layer-group text-white text-xl md:text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-2xl md:text-3xl font-bold text-slate-800">{{ learned_flashcards_count }}</p>
                                <p class="text-xs md:text-sm font-semibold text-slate-500">O'zlashtirilgan So'z</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
// (JS qismi o'zgarishsiz qoladi)
document.addEventListener('DOMContentLoaded', () => {
    const weeklyCtx = document.getElementById('weeklyProgressChart');
    if (weeklyCtx) {
        // ... (Chart mantiqi o'zgarishsiz qoladi)
        const chartLabels = JSON.parse('{{ chart_labels|safe }}');
        const examScoreData = JSON.parse('{{ exam_score_data|safe }}');
        const flashcardData = JSON.parse('{{ flashcard_data|safe }}');

        const isMobile = window.innerWidth < 768;
        const fontSize = isMobile ? 10 : 12;
        const titleFontSize = isMobile ? 12 : 14;

        new Chart(weeklyCtx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Imtihon Balli',
                    data: examScoreData,
                    borderColor: 'rgb(79, 70, 229)',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    yAxisID: 'yExams',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2,
                    pointRadius: isMobile ? 3 : 4,
                    pointHoverRadius: isMobile ? 5 : 6,
                }, {
                    label: "O'rganilgan so'zlar",
                    data: flashcardData,
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    yAxisID: 'yFlashcards',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2,
                    pointRadius: isMobile ? 3 : 4,
                    pointHoverRadius: isMobile ? 5 : 6,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: isMobile ? 'bottom' : 'top',
                        labels: {
                            boxWidth: isMobile ? 10 : 15,
                            padding: isMobile ? 8 : 10,
                            font: {
                                size: fontSize
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: isMobile ? 8 : 12,
                        titleFont: {
                            size: titleFontSize
                        },
                        bodyFont: {
                            size: fontSize
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            font: {
                                size: fontSize
                            },
                            maxRotation: isMobile ? 45 : 0,
                            minRotation: isMobile ? 45 : 0
                        },
                        grid: {
                            display: false
                        }
                    },
                    yExams: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        suggestedMin: 800,
                        suggestedMax: 1600,
                        ticks: {
                            font: {
                                size: fontSize
                            }
                        },
                        title: {
                            display: !isMobile,
                            text: 'SAT Ball',
                            font: {
                                size: titleFontSize
                            }
                        }
                    },
                    yFlashcards: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        max: 36,
                        ticks: {
                            stepSize: 4,
                            font: {
                                size: fontSize
                            }
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        title: {
                            display: !isMobile,
                            text: "So'zlar soni",
                            font: {
                                size: titleFontSize
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });

        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                location.reload();
            }, 500);
        });
    }
});
</script>

{% endblock %}