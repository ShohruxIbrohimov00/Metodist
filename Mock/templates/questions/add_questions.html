{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{% trans "Yangi savol qo'shish" %}{% endblock %}

{% block extra_css %}
<style>
    /* CSS qismi to'liq saqlangan */
    .select2-container--classic .select2-selection--single,
    .select2-container--classic .select2-selection--multiple {
        border-color: #d1d5db !important;
        border-radius: 0.375rem !important;
        padding: 0.5rem !important;
        height: auto !important;
        min-height: 42px;
    }
    #question-form input:not([type="checkbox"]):not([type="radio"]),
    #question-form select:not(.select2-hidden-accessible),
    #question-form textarea:not(.cke_source) {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem;
        box-shadow: 0 0 0 1px rgba(99, 102, 241, 0);
    }
    .option-item input[type="radio"],
    .option-item input[type="checkbox"] {
        height: 1.25rem;
        width: 1.25rem;
        color: #4f46e5;
    }
    /* ðŸ’¡ Eng muhim o'zgarish: o'chirilgan formlar yashirin bo'ladi */
    .option-item.deleted {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-8 max-w-5xl">
    <div class="bg-white shadow-xl rounded-xl p-6 md:p-8 border border-gray-100">
        <h2 class="text-3xl font-extrabold text-gray-900 mb-2">{% trans "Yangi savol qo'shish" %}</h2>
        <p class="text-gray-600 mb-8 border-b pb-4">{% trans "Savol matni, javoblar va IRT parametrlarni to'g'ri kiriting." %}</p>

        <form action="{% url 'add_question' slug=center.slug %}" method="POST" enctype="multipart/form-data" id="question-form" class="space-y-8">
            {% csrf_token %}
            {{ form.center }}

            {# Savol matni va IRT parametrlari qismi #}
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-question-circle mr-3 text-indigo-600"></i>{% trans "Savol matni va IRT parametrlari" %}
                </h3>
                <div class="space-y-4">
                    <div>
                        <label for="{{ form.text.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "Savol matni" %} <span class="text-red-500">*</span></label>
                        {{ form.text }}
                        {% if form.text.errors %}<p class="text-red-500 text-sm mt-1">{{ form.text.errors }}</p>{% endif %}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {% for field in irt_fields %}
                            <div>
                                <label for="{{ field.id_for_label }}" class="block text-gray-700 font-medium mb-1">{{ field.label }}</label>
                                {{ field }}
                                {% if field.help_text %}<p class="text-gray-500 text-sm mt-1">{{ field.help_text }}</p>{% endif %}
                                {% if field.errors %}<p class="text-red-500 text-sm mt-1">{{ field.errors }}</p>{% endif %}
                            </div>
                        {% endfor %}

                        <div class="flex items-center h-full pt-6 md:pt-0">
                            <div class="flex items-center">
                                {{ form.is_solution_free }}
                                <label for="{{ form.is_solution_free.id_for_label }}" class="ml-2 text-sm font-medium text-gray-700">{% trans "Yechim bepulmi?" %}</label>
                            </div>
                            {% if form.is_solution_free.errors %}<p class="text-red-500 text-sm mt-1">{{ form.is_solution_free.errors }}</p>{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {# Savol turi va javoblar qismi #}
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-edit mr-3 text-indigo-600"></i>{% trans "Savol turi va javoblar" %}
                </h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="{{ form.subtopic.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "Ichki mavzu" %} <span class="text-red-500">*</span></label>
                            {{ form.subtopic }}
                            {% if form.subtopic.errors %}<p class="text-red-500 text-sm mt-1">{{ form.subtopic.errors }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.answer_format.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "Javob formati" %} <span class="text-red-500">*</span></label>
                            {{ form.answer_format }}
                            {% if form.answer_format.errors %}<p class="text-red-500 text-sm mt-1">{{ form.answer_format.errors }}</p>{% endif %}
                        </div>
                    </div>
                </div>
            </div>


            {# Javob variantlari (Single/Multiple) #}
            <div id="options-container" class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-list-ul mr-3 text-indigo-600"></i>{% trans "Javob variantlari" %}
                </h3>
                <p class="text-red-500 text-sm mb-4" id="options-formset-errors">
                    {% if answer_option_formset.non_form_errors %}
                        {{ answer_option_formset.non_form_errors }}
                    {% endif %}
                    {% for form in answer_option_formset %}
                        {% if form.non_field_errors %}
                            {{ form.non_field_errors }}
                        {% endif %}
                    {% endfor %}
                </p>
                
                <div id="options-list" class="space-y-4">
                    {{ answer_option_formset.management_form }}
                    {% for option_form in answer_option_formset %}
                    {# Formset to'liq 5 ta bo'lishi kerak, ularning hammasi bu yerda chiqadi. #}
                    <div class="option-item bg-white p-4 rounded-lg border border-gray-300 shadow-sm transition duration-150 {% if option_form.DELETE.value %}deleted{% endif %}">
                        <div class="flex items-center mb-3 gap-4">
                            <div class="flex items-center">
                                {# is_correct maydonining o'rnini JS egallaydi #}
                                <label for="{{ option_form.is_correct.id_for_label }}" class="text-gray-700 font-medium">{% trans "To'g'ri" %}</label>
                            </div>
                            <button type="button" class="remove-option text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition duration-150 ml-auto" title="{% trans 'Oâ€˜chirish' %}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            {% if option_form.id %} {{ option_form.id }} {% endif %}
                            
                            {# Asl Django checkboxlari (yashiriladi) #}
                            <div class="hidden-fields hidden">
                                {{ option_form.is_correct }}
                                {{ option_form.DELETE }} 
                            </div>
                        </div>
                        {{ option_form.text }}
                        {% if option_form.text.errors %}<p class="text-red-500 text-sm mt-1">{{ option_form.text.errors }}</p>{% endif %}
                    </div>
                    {% endfor %}
                </div>
                
                {# ðŸ’¡ "Javob varianti qo'shish" tugmasini olib tashladik. #}
            </div>

            {# Qisqa javob (Short Answer) qismi #}
            <div id="short-answer-field-container" class="bg-gray-50 p-6 rounded-xl border border-gray-200 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-keyboard mr-3 text-indigo-600"></i>{% trans "Qisqa javob" %}
                </h3>
                <div>
                    <label for="{{ form.correct_short_answer.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "To'g'ri javob matni" %} <span class="text-red-500">*</span></label>
                    {{ form.correct_short_answer }}
                    <p class="text-gray-500 text-sm mt-1">{% trans "Masalan: 42 yoki 3.14. Raqamlar, vergul yoki oddiy matn bo'lishi mumkin." %}</p>
                    {% if form.correct_short_answer.errors %}<p class="text-red-500 text-sm mt-1">{{ form.correct_short_answer.errors }}</p>{% endif %}
                </div>
            </div>

            {# Yechim (Hint/Solution) qismi #}
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-book-open mr-3 text-indigo-600"></i>{% trans "Yechim" %}
                </h3>
                <div class="space-y-4">
                    <div>
                        <label for="{{ form.hint.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "Maslahat (Hint)" %}</label>
                        {{ form.hint }}
                        {% if form.hint.errors %}<p class="text-red-500 text-sm mt-1">{{ form.hint.errors }}</p>{% endif %}
                    </div>
                    <div>
                        <label for="{{ form.detailed_solution.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "Batafsil yechim" %}</label>
                        {{ form.detailed_solution }}
                        {% if form.detailed_solution.errors %}<p class="text-red-500 text-sm mt-1">{{ form.detailed_solution.errors }}</p>{% endif %}
                    </div>
                </div>
            </div>

            {# Teglar va Flashcardlar qismi #}
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-tags mr-3 text-indigo-600"></i>{% trans "Teglar va Flashcardlar" %}
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="{{ form.tags.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "Teglar" %}</label>
                        {{ form.tags }}
                        {% if form.tags.errors %}<p class="text-red-500 text-sm mt-1">{{ form.tags.errors }}</p>{% endif %}
                    </div>
                    <div>
                        <label for="{{ form.flashcards.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "Flashcardlar" %}</label>
                        {{ form.flashcards }}
                        {% if form.flashcards.errors %}<p class="text-red-500 text-sm mt-1">{{ form.flashcards.errors }}</p>{% endif %}
                    </div>
                </div>
            </div>

            {# Tugmalar qismi #}
            <div class="flex flex-col sm:flex-row justify-end mt-6 space-y-3 sm:space-y-0 sm:space-x-3 border-t pt-6">
                <a href="{% url 'subtopic_questions' slug=center.slug subtopic_id=form.subtopic.value %}" class="inline-flex items-center justify-center px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    <i class="fas fa-times mr-2"></i>{% trans "Bekor qilish" %}
                </a>
                <button type="submit" name="save" class="inline-flex items-center justify-center px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg">
                    <i class="fas fa-save mr-2"></i>{% trans "Saqlash" %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ form.media }}
<script src="{% static 'js/add_question_custom.js' %}"></script>
<script>
    // ðŸ’¡ MUHIM: CKEDITOR_SECURITY_NOTICE ni yoqamiz
    window.CKEDITOR_SECURITY_NOTICE = false;

    // --- CKEditor Umumiy Konfiguratsiyasi ---
    
    // settings.py dagi upload URL manzillarini kiritamiz (Asosiy yechim)
    const editorConfig = {
        skin: 'moono-lisa',
        toolbar: [
            ['Styles', 'Format', 'Bold', 'Italic', 'Underline', 'Strike', 'SpellChecker', 'Undo', 'Redo'],
            ['Link', 'Unlink', 'Anchor'],
            ['Image', 'Table', 'HorizontalRule'], 
            ['TextColor', 'BGColor'],
            ['Smiley', 'SpecialChar'],
            ['Source', 'Maximize']
        ],
        extraPlugins: 'codesnippet,image2,autogrow', 
        removePlugins: 'exportpdf,flash', 
        removeButtons: 'Flash,ExportPdf', 
        
        // ðŸš€ CKEditor Yuklash Manzilini qo'shamiz - ASOSIY YECHIM!
        filebrowserUploadUrl: '/ckeditor/upload/',
        filebrowserBrowseUrl: '/ckeditor/browse/',

        image2_alignClasses: ['image-left', 'image-center', 'image-right'],
        image2_toolbar: ['|', 'imageTextAlternative', '|', 'imageWidth', 'imageHeight', 'imageStyle', '|', 'imageResize', 'imageResizeWidth', 'imageResizeHeight'],
        image2_config: {'maxWidth': 800},
        resize_enabled: true, 
        
        height: 150, 
        autoGrow_onStartup: true,
        editorplaceholder: ' ',
        readOnly: false
    };

    // --- Yordamchi Funksiya: HTML Entitiesni Dekodlash ---
    function decodeHtml(html) {
        var txt = document.createElement("textarea");
        txt.innerHTML = html;
        return txt.value;
    }

    // --- CKEditorni O'rnatish/O'chirish Funksiyasi ---
    function toggleCKEditor(id, enable = true, config = editorConfig) {
        if (typeof CKEDITOR === 'undefined') {
            return;
        }
        
        if (CKEDITOR.instances[id]) {
            CKEDITOR.instances[id].destroy(true); 
        }
        
        if (enable && $('#' + id).length) {
            try {
                const editor = CKEDITOR.replace(id, config);
                editor.on('instanceReady', function(evt) {
                    if ($('#' + id).is(':visible')) {
                        evt.editor.focus();
                    }
                });
            } catch (e) {
                console.error('CKEditor replace xatosi:', e);
            }
        }
    }

    // --- Formset Boshqaruvchi Funksiya: Javob Variantlari Kirish Turi ---
    function updateOptionInputs(format) {
        const inputType = format === 'single' ? 'radio' : 'checkbox';
        const radioGroupName = 'single_correct_answer_radio_group';
        
        const correctLabelText = $.trim($('.option-item label[for]:first').text());
        
        $('#options-list .option-item:not(.deleted)').each(function(index) {
            const $item = $(this);
            const $djangoInput = $item.find(`input[name$="-is_correct"]`); 
            
            $item.find('.is_correct_input').remove();
            
            const formsetId = $djangoInput.attr('id');
            const isChecked = $djangoInput.prop('checked') || false; 
            
            const newNameAttr = format === 'single' ? radioGroupName : $djangoInput.attr('name');
            const newInput = $(`<input type="${inputType}" name="${newNameAttr}" id="${formsetId}_display" class="form-checkbox h-5 w-5 text-indigo-600 mr-2 is_correct_input" ${isChecked ? 'checked' : ''}>`);
            
            $item.find('.flex.items-center:first').prepend(newInput);
            
            $item.find('label[for]').each(function() {
                const $label = $(this);
                if ($.trim($label.text()) === correctLabelText) { 
                    $label.attr('for', newInput.attr('id')); 
                }
            });

            newInput.removeClass('form-radio form-checkbox').addClass(format === 'single' ? 'form-radio' : 'form-checkbox');
        });

        $('#options-list').off('change', '.option-item .is_correct_input');
        $('#options-list').on('change', '.option-item .is_correct_input', function() {
            const $item = $(this).closest('.option-item');
            const $djangoInput = $item.find('input[name$="-is_correct"]');
            
            if ($(this).attr('type') === 'radio') {
                $('#options-list .option-item:not(.deleted)').each(function() {
                     $(this).find('input[name$="-is_correct"]').prop('checked', false);
                });
                $djangoInput.prop('checked', true);
            } else {
                $djangoInput.prop('checked', $(this).is(':checked'));
            }
        });
        
        if (format === 'single') {
            const checkedRadios = $('#options-list .option-item:not(.deleted) .is_correct_input[type="radio"]:checked');
            if (checkedRadios.length > 1) {
                checkedRadios.slice(1).prop('checked', false);
                checkedRadios.slice(1).closest('.option-item').find('input[name$="-is_correct"]').prop('checked', false);
            }
        }
    }

    // --- Formset Boshqaruvchi Funksiya: Variantni O'chirish ---
    function deleteOption(e) {
        e.preventDefault();
        const $item = $(this).closest('.option-item');
        const deleteInput = $item.find('input[name$="-DELETE"]');
        const textareaId = $item.find('textarea').attr('id');

        if (confirm('{% trans "Haqiqatan ham bu javob variantini oâ€˜chirmoqchimisiz?"|escapejs %}')) {
            if (CKEDITOR.instances[textareaId]) {
                CKEDITOR.instances[textareaId].setData(''); 
            }
            
            $item.find('input').val('').prop('checked', false);
            
            $item.addClass('deleted').hide();
            deleteInput.prop('checked', true); 
            
            $item.find('input[name$="-is_correct"]').prop('checked', false);
            $item.find('.is_correct_input').prop('checked', false);
            
            updateOptionInputs($('#id_answer_format').val()); 
        }
    }


    // --- Document Ready / Boshlang'ich Holat va Saqlash Mantiqi ---

    $(document).ready(function() {
        const optionsList = $('#options-list');
        const answerFormatSelect = $('#id_answer_format');

        // 1. SELECT2 ELEMENTLARINI TIKLASH 
        const select2Config = { 
            theme: "classic", 
            width: '100%',
            templateSelection: function(data) {
                if (data.text) {
                    return decodeHtml(data.text);
                }
                return data.text;
            },
            templateResult: function(data) {
                if (data.text) {
                    return decodeHtml(data.text);
                }
                return data.text;
            }
        };
        
        const multipleSelect2Config = Object.assign({}, select2Config, {});

        $('#id_subtopic').select2(select2Config);
        $('#id_tags').select2(multipleSelect2Config);
        $('#id_flashcards').select2(multipleSelect2Config);
        
        answerFormatSelect.select2({theme: "classic", width: '100%', allowClear: true});


        // 2. Asosiy editorlarni ishga tushirish (yangilangan config bilan)
        // Har bir maydon uchun alohida balandlik berish uchun Object.assign ishlatiladi.
        toggleCKEditor('id_text', true, Object.assign({}, editorConfig, { height: 200 }));
        toggleCKEditor('id_hint', true, Object.assign({}, editorConfig, { height: 150 }));
        toggleCKEditor('id_detailed_solution', true, Object.assign({}, editorConfig, { height: 200 }));
        
        // O'chirish eventini bog'lash
        $('#options-list').on('click', '.remove-option', deleteOption);


        // 3. Barcha mavjud variantlar uchun CKEditorni ishga tushirish 
        optionsList.find('.option-item').each(function() {
            const $item = $(this);
            const textareaId = $item.find('textarea').attr('id');

            if (!$item.hasClass('deleted')) {
                toggleCKEditor(textareaId, true, editorConfig); // config ni uzatamiz
            }
            if ($item.find('input[name$="-DELETE"]').prop('checked')) {
                 $item.addClass('deleted').hide();
            }
        });
        
        // 4. Javob formatini boshqarish 
        answerFormatSelect.on('select2:select', function() {
            const selectedFormat = $(this).val() || 'single';
            
            if (selectedFormat === 'single' || selectedFormat === 'multiple') {
                $('#options-container').removeClass('hidden');
                $('#short-answer-field-container').addClass('hidden');
                
                optionsList.find('.option-item:not(.deleted) textarea').each(function() {
                    toggleCKEditor($(this).attr('id'), true, editorConfig);
                });
                updateOptionInputs(selectedFormat);

            } else if (selectedFormat === 'short_answer') {
                $('#options-container').addClass('hidden');
                $('#short-answer-field-container').removeClass('hidden');
                
                optionsList.find('.option-item:not(.deleted) textarea').each(function() {
                    toggleCKEditor($(this).attr('id'), false);
                });
            }
        });

        const initialFormat = answerFormatSelect.val() || 'single';
        answerFormatSelect.val(initialFormat).trigger('change');
        updateOptionInputs(initialFormat);

        
        // 5. Saqlashda Bo'sh Variantlarni E'tiborsiz Qoldirish Mantiqi
        $('#question-form').on('submit', function(e) {
            
            for (const instance in CKEDITOR.instances) {
                 if (!CKEDITOR.instances[instance].element.hasClass('deleted')) {
                      CKEDITOR.instances[instance].updateElement();
                 }
            }
            
            optionsList.find('.option-item').each(function() {
                const $item = $(this);
                const isExplicitlyDeleted = $item.find('input[name$="-DELETE"]').prop('checked');
                
                if (!isExplicitlyDeleted) {
                    const content = $item.find('textarea').val().trim(); 
                    const strippedContent = content.replace(/<[^>]*>/g, '').trim();
                    
                    if (!strippedContent) {
                        $item.find('input[name$="-DELETE"]').prop('checked', true);
                        $item.addClass('deleted');
                        $item.find('input[name$="-is_correct"]').prop('checked', false);
                    }
                }
            });
            
            const answerFormat = $('#id_answer_format').val();
            const correctOptions = $('#options-list .option-item:not(.deleted) .is_correct_input:checked').length;
            
            $('#options-formset-errors').text(''); 
            
            if ((answerFormat === 'single' || answerFormat === 'multiple') && $('#options-list .option-item:not(.deleted)').length < 2) {
                e.preventDefault();
                $('#options-formset-errors').text('Yagona/ko\'p javob formatida kamida ikkita toâ€˜ldirilgan variant boâ€˜lishi kerak.');
            }
            else if (answerFormat === 'single' && correctOptions !== 1) {
                e.preventDefault();
                $('#options-formset-errors').text('Yagona javob formatida faqat bitta toâ€˜gâ€˜ri javob tanlanishi kerak.');
            } else if (answerFormat === 'multiple' && correctOptions === 0) {
                e.preventDefault();
                $('#options-formset-errors').text('Bir nechta javob formatida kamida bitta toâ€˜gâ€˜ri javob tanlanishi kerak.');
            }
            
            const radioGroupName = 'single_correct_answer_radio_group';
            if (answerFormat === 'single') {
                const checkedRadio = $(`input[name="${radioGroupName}"]:checked`);
                if (checkedRadio.length) {
                    const index = checkedRadio.closest('.option-item').index('#options-list .option-item');
                    checkedRadio.attr('name', `answer_option-${index}-is_correct`);
                }
            }
        });
    });
</script>
{% endblock %}
