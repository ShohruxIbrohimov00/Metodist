{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{% trans "Yangi savol qo'shish" %}{% endblock %}
{% block extra_head %}
    <!-- CKEditor 4 CDN (to'liq versiya + barcha pluginlar) -->
    <script src="https://cdn.ckeditor.com/4.22.1/full-all/ckeditor.js"></script>

    <!-- MathJax (matematik formulalar uchun) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS_HTML"></script>
{% endblock %}
{% block extra_css %}
<style>
    /* CSS qismi to'liq saqlangan */
    .select2-container--classic .select2-selection--single,
    .select2-container--classic .select2-selection--multiple {
        border-color: #d1d5db !important;
        border-radius: 0.375rem !important;
        padding: 0.5rem !important;
        height: auto !important;
        min-height: 42px;
    }
    #question-form input:not([type="checkbox"]):not([type="radio"]),
    #question-form select:not(.select2-hidden-accessible),
    #question-form textarea:not(.cke_source) {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem;
        box-shadow: 0 0 0 1px rgba(99, 102, 241, 0);
    }
    .option-item input[type="radio"],
    .option-item input[type="checkbox"] {
        height: 1.25rem;
        width: 1.25rem;
        color: #4f46e5;
    }
    /* ðŸ’¡ Eng muhim o'zgarish: o'chirilgan formlar yashirin bo'ladi */
    .option-item.deleted {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-8 max-w-5xl">
    <div class="bg-white shadow-xl rounded-xl p-6 md:p-8 border border-gray-100">
        <h2 class="text-3xl font-extrabold text-gray-900 mb-2">{% trans "Yangi savol qo'shish" %}</h2>
        <p class="text-gray-600 mb-8 border-b pb-4">{% trans "Savol matni, javoblar va IRT parametrlarni to'g'ri kiriting." %}</p>

        <form action="{% url 'add_question' slug=center.slug %}" method="POST" enctype="multipart/form-data" id="question-form" class="space-y-8">
            {% csrf_token %}
            {{ form.center }}

            {# Savol matni va IRT parametrlari qismi #}
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-question-circle mr-3 text-indigo-600"></i>{% trans "Savol matni va IRT parametrlari" %}
                </h3>
                <div class="space-y-4">
                    <div>
                        <label for="{{ form.text.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "Savol matni" %} <span class="text-red-500">*</span></label>
                        {{ form.text }}
                        {% if form.text.errors %}<p class="text-red-500 text-sm mt-1">{{ form.text.errors }}</p>{% endif %}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {% for field in irt_fields %}
                            <div>
                                <label for="{{ field.id_for_label }}" class="block text-gray-700 font-medium mb-1">{{ field.label }}</label>
                                {{ field }}
                                {% if field.help_text %}<p class="text-gray-500 text-sm mt-1">{{ field.help_text }}</p>{% endif %}
                                {% if field.errors %}<p class="text-red-500 text-sm mt-1">{{ field.errors }}</p>{% endif %}
                            </div>
                        {% endfor %}

                        <div class="flex items-center h-full pt-6 md:pt-0">
                            <div class="flex items-center">
                                {{ form.is_solution_free }}
                                <label for="{{ form.is_solution_free.id_for_label }}" class="ml-2 text-sm font-medium text-gray-700">{% trans "Yechim bepulmi?" %}</label>
                            </div>
                            {% if form.is_solution_free.errors %}<p class="text-red-500 text-sm mt-1">{{ form.is_solution_free.errors }}</p>{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {# Savol turi va javoblar qismi #}
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-edit mr-3 text-indigo-600"></i>{% trans "Savol turi va javoblar" %}
                </h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="{{ form.subtopic.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "Ichki mavzu" %} <span class="text-red-500">*</span></label>
                            {{ form.subtopic }}
                            {% if form.subtopic.errors %}<p class="text-red-500 text-sm mt-1">{{ form.subtopic.errors }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.answer_format.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "Javob formati" %} <span class="text-red-500">*</span></label>
                            {{ form.answer_format }}
                            {% if form.answer_format.errors %}<p class="text-red-500 text-sm mt-1">{{ form.answer_format.errors }}</p>{% endif %}
                        </div>
                    </div>
                </div>
            </div>


            {# Javob variantlari (Single/Multiple) #}
            <div id="options-container" class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-list-ul mr-3 text-indigo-600"></i>{% trans "Javob variantlari" %}
                </h3>
                <p class="text-red-500 text-sm mb-4" id="options-formset-errors">
                    {% if answer_option_formset.non_form_errors %}
                        {{ answer_option_formset.non_form_errors }}
                    {% endif %}
                    {% for form in answer_option_formset %}
                        {% if form.non_field_errors %}
                            {{ form.non_field_errors }}
                        {% endif %}
                    {% endfor %}
                </p>
                
                <div id="options-list" class="space-y-4">
                    {{ answer_option_formset.management_form }}
                    {% for option_form in answer_option_formset %}
                    {# Formset to'liq 5 ta bo'lishi kerak, ularning hammasi bu yerda chiqadi. #}
                    <div class="option-item bg-white p-4 rounded-lg border border-gray-300 shadow-sm transition duration-150 {% if option_form.DELETE.value %}deleted{% endif %}">
                        <div class="flex items-center mb-3 gap-4">
                            <div class="flex items-center">
                                {# is_correct maydonining o'rnini JS egallaydi #}
                                <label for="{{ option_form.is_correct.id_for_label }}" class="text-gray-700 font-medium">{% trans "To'g'ri" %}</label>
                            </div>
                            <button type="button" class="remove-option text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition duration-150 ml-auto" title="{% trans 'Oâ€˜chirish' %}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            {% if option_form.id %} {{ option_form.id }} {% endif %}
                            
                            {# Asl Django checkboxlari (yashiriladi) #}
                            <div class="hidden-fields hidden">
                                {{ option_form.is_correct }}
                                {{ option_form.DELETE }} 
                            </div>
                        </div>
                        {{ option_form.text }}
                        {% if option_form.text.errors %}<p class="text-red-500 text-sm mt-1">{{ option_form.text.errors }}</p>{% endif %}
                    </div>
                    {% endfor %}
                </div>
                
                {# ðŸ’¡ "Javob varianti qo'shish" tugmasini olib tashladik. #}
            </div>

            {# Qisqa javob (Short Answer) qismi #}
            <div id="short-answer-field-container" class="bg-gray-50 p-6 rounded-xl border border-gray-200 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-keyboard mr-3 text-indigo-600"></i>{% trans "Qisqa javob" %}
                </h3>
                <div>
                    <label for="{{ form.correct_short_answer.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "To'g'ri javob matni" %} <span class="text-red-500">*</span></label>
                    {{ form.correct_short_answer }}
                    <p class="text-gray-500 text-sm mt-1">{% trans "Masalan: 42 yoki 3.14. Raqamlar, vergul yoki oddiy matn bo'lishi mumkin." %}</p>
                    {% if form.correct_short_answer.errors %}<p class="text-red-500 text-sm mt-1">{{ form.correct_short_answer.errors }}</p>{% endif %}
                </div>
            </div>

            {# Yechim (Hint/Solution) qismi #}
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-book-open mr-3 text-indigo-600"></i>{% trans "Yechim" %}
                </h3>
                <div class="space-y-4">
                    <div>
                        <label for="{{ form.hint.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "Maslahat (Hint)" %}</label>
                        {{ form.hint }}
                        {% if form.hint.errors %}<p class="text-red-500 text-sm mt-1">{{ form.hint.errors }}</p>{% endif %}
                    </div>
                    <div>
                        <label for="{{ form.detailed_solution.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "Batafsil yechim" %}</label>
                        {{ form.detailed_solution }}
                        {% if form.detailed_solution.errors %}<p class="text-red-500 text-sm mt-1">{{ form.detailed_solution.errors }}</p>{% endif %}
                    </div>
                </div>
            </div>

            {# Teglar va Flashcardlar qismi #}
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-tags mr-3 text-indigo-600"></i>{% trans "Teglar va Flashcardlar" %}
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="{{ form.tags.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "Teglar" %}</label>
                        {{ form.tags }}
                        {% if form.tags.errors %}<p class="text-red-500 text-sm mt-1">{{ form.tags.errors }}</p>{% endif %}
                    </div>
                    <div>
                        <label for="{{ form.flashcards.id_for_label }}" class="block text-gray-700 font-medium mb-1">{% trans "Flashcardlar" %}</label>
                        {{ form.flashcards }}
                        {% if form.flashcards.errors %}<p class="text-red-500 text-sm mt-1">{{ form.flashcards.errors }}</p>{% endif %}
                    </div>
                </div>
            </div>

            {# Tugmalar qismi #}
            <div class="flex flex-col sm:flex-row justify-end mt-6 space-y-3 sm:space-y-0 sm:space-x-3 border-t pt-6">
                <a href="{% url 'subtopic_questions' slug=center.slug subtopic_id=form.subtopic.value %}" class="inline-flex items-center justify-center px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    <i class="fas fa-times mr-2"></i>{% trans "Bekor qilish" %}
                </a>
                <button type="submit" name="save" class="inline-flex items-center justify-center px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg">
                    <i class="fas fa-save mr-2"></i>{% trans "Saqlash" %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CKEditor global config (CDN uchun to'g'ri yo'l shart emas â€“ hammasi CDN dan keladi)
const editorConfig = {
    language: 'ru',
    height: 200,
    toolbar: 'full',
    extraPlugins: 'mathjax,image2,codesnippet,autogrow,uploadimage',
    removePlugins: 'exportpdf',
    
    // MathJax (matematik formulalar)
    mathJaxLib: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS_HTML',
    mathJaxClass: 'math-tex',  // \( x^2 \) ishlatish uchun

    // Rasm yuklash (faqat django-ckeditor uploader ishlatiladi)
    filebrowserUploadUrl: '/ckeditor/upload/',
    filebrowserBrowseUrl: '/ckeditor/browse/',

    // Avto o'lcham
    autoGrow_onStartup: true,
    autoGrow_minHeight: 150,
    autoGrow_maxHeight: 600,

    // Kod snippet uchun
    codeSnippet_theme: 'monokai_sublime',
};
// SIZNING ESKI FUNKSÄ°YANGIZ â€“ muhim, boâ€˜lmasa radio/checkbox buziladi
function updateOptionInputs(format) {
    const inputType = format === 'single' ? 'radio' : 'checkbox';
    const radioGroupName = 'single_correct_answer_radio_group';

    $('#options-list .option-item:not(.deleted)').each(function() {
        const $item = $(this);
        const $djangoInput = $item.find('input[name$="-is_correct"]');
        const isChecked = $djangoInput.prop('checked');

        $item.find('.is_correct_input').remove();

        const newName = format === 'single' ? radioGroupName : $djangoInput.attr('name');
        const newInput = $(`<input type="${inputType}" class="is_correct_input h-5 w-5 text-indigo-600 mr-3" name="${newName}" ${isChecked ? 'checked' : ''}>`);

        $item.find('.flex.items-center').first().prepend(newInput);
        $item.find('label:contains("To\'g\'ri")').attr('for', newInput.attr('id') || '');
    });

    // Single choice boâ€˜lsa faqat bittasini qoldirish
    if (format === 'single') {
        const $checked = $('#options-list .is_correct_input[type="radio"]:checked');
        if ($checked.length > 1) {
            $checked.not(':first').prop('checked', false);
            $checked.not(':first').closest('.option-item').find('input[name$="-is_correct"]').prop('checked', false);
        }
    }
}
// Yordamchi funksiya
function toggleCKEditor(id, enable = true) {
    if (typeof CKEDITOR === 'undefined') return;

    if (CKEDITOR.instances[id]) {
        CKEDITOR.instances[id].destroy(true);
    }

    if (enable && document.getElementById(id)) {
        CKEDITOR.replace(id, editorConfig);
    }
}

// Hujjat tayyor bo'lganda
$(document).ready(function() {
    // 1. Asosiy editorlarni yoqamiz
    toggleCKEditor('id_text');
    toggleCKEditor('id_hint');
    toggleCKEditor('id_detailed_solution');

    // 2. Javob variantlaridagi editorlarni yoqamiz
    $('.option-item:not(.deleted)').each(function() {
        const textareaId = $(this).find('textarea').attr('id');
        if (textareaId) toggleCKEditor(textareaId);
    });

    // 3. Javob formati o'zgarganda
    $('#id_answer_format').on('change', function() {
        const format = $(this).val();
        if (format === 'short_answer') {
            $('#options-container').addClass('hidden');
            $('#short-answer-field-container').removeClass('hidden');
            // Variant editorlarini o'chiramiz
            $('.option-item textarea').each(function() {
                toggleCKEditor(this.id, false);
            });
        } else {
            $('#options-container').removeClass('hidden');
            $('#short-answer-field-container').addClass('hidden');
            // Variant editorlarini qayta yoqamiz
            $('.option-item:not(.deleted)').each(function() {
                const textareaId = $(this).find('textarea').attr('id');
                if (textareaId) toggleCKEditor(textareaId);
            });
        }
        updateOptionInputs(format); // sizning eski funksiyangiz ishlaydi
    }).trigger('change');

    // 4. Variant o'chirilganda CKEditorni tozalaymiz
    $(document).on('click', '.remove-option', function(e) {
        e.preventDefault();
        const $item = $(this).closest('.option-item');
        const textareaId = $item.find('textarea').attr('id');
        if (confirm('Haqiqatan ham oâ€˜chirasizmi?')) {
            if (CKEDITOR.instances[textareaId]) {
                CKEDITOR.instances[textareaId].setData('');
            }
            $item.addClass('deleted').hide();
            $item.find('input[name$="-DELETE"]').prop('checked', true);
            updateOptionInputs($('#id_answer_format').val());
        }
    });

    // 5. Form yuborilganda barcha editorlarni yangilaymiz
    $('#question-form').on('submit', function() {
        for (const instance in CKEDITOR.instances) {
            CKEDITOR.instances[instance].updateElement();
        }
    });
});
</script>
{% endblock %}
